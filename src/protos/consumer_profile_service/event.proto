syntax = "proto3";

package doordash_consumer_profile_service;

import "consumer_profile_service/common.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/doordash/services-protobuf/generated/consumer_profile_service";
option java_generic_services = true;
option java_multiple_files = true;
option java_package = "com.doordash.rpc.consumer_profile_service";

// Events published to the `consumer_events` topic.
message ConsumerEvent {
  // A oneof is used so that there's a common type for the event publisher
  oneof event {
    // See documentation below.
    ConsumerCreatedEvent consumer_created = 1;
    ConsumerMigratedEvent consumer_migrated = 2;
  }
}

/**
 * Publish when a Guest Consumer is migrated to an authenticated Cx via COPS.
 *  This can happen when guest Cx does signin/signup
 */
message ConsumerMigratedEvent {
  string from_consumer_id = 1;
  string from_user_id = 2;
  ConsumerProfileType from_consumer_type = 3;

  string to_consumer_id = 4;
  string to_user_id = 5;
  ConsumerProfileType to_consumer_type = 6;

  // Typically DOORDASH or CAVIAR, should never be unspecified.
  ConsumerExperience experience = 7;
  google.protobuf.Timestamp created_at = 8;
}

/**
 * Publish when a (non-guest) Consumer gets created via COPS.
 *  This can happen on signup, or if a user has a DoorDash account
 *  and signs up for Caviar (and vice-versa).
 */
message ConsumerCreatedEvent {
  // Primary key (numeric)
  string id = 1;
  // Reference to Identity's User (numeric)
  string user_id = 2;
  // Typically DOORDASH or CAVIAR, should never be unspecified.
  ConsumerExperience experience = 3;
  // From database.
  google.protobuf.Timestamp created_at = 4;
}

/**
 * Type of change made to the consumer address link
 */
enum ConsumerAddressLinkEventType {
  // unknown
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_UNSPECIFIED = 0;
  // consumer address link created
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_CREATE = 1;
  // consumer address link patched
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_PATCH = 2;
  // consumer address link deleted
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_DELETE = 3;
}

/**
 * Changes made to the consumer address link
 */
message ConsumerAddressLinkEvent {
  // primary key of the consumer address link
  string consumer_address_link_id = 1;
  // consumer ID
  string consumer_id = 2;
  // address ID generated by Geo
  string address_id = 3;
  // instructions to the dasher
  string dasher_instructions = 4;
  // subpremise (for example, apartment number)
  string subpremise = 5;
  // latitude of the manual point
  double manual_lat = 6;
  // longitude of the manual point
  double manual_lng = 7;

  // the JSON representation of the request proto coming into COPS
  string request_blob = 21;
  // type of change made to the consumer address link
  ConsumerAddressLinkEventType event_type = 22;
  // timestamp of the change
  google.protobuf.Timestamp sent_at = 23;

  // name of the personal address label associated with the consumer address link
  google.protobuf.StringValue label_name = 24;
  // icon of the personal address label associated with the consumer address link
  google.protobuf.StringValue label_icon = 25;
  // type of change made to the address label
  PersonalAddressLabelEventType label_event_type = 26;
}

// Type of change made to the associated personal address label
enum PersonalAddressLabelEventType {
  // unknown
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_UNSPECIFIED = 0;
  // personal address label was created
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_CREATE = 1;
  // personal address label was updated
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_UPDATE = 2;
  // personal address label was deleted
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_DELETE = 3;
}

/*
 * Savelist Event contains data regarding updates on store bookmarks and savelists
 * Tech design: https://drd.sh/0JP35zg8TsgBhebN/
 */
message SavelistUpdateEvent {
  /* Creator's consumer id */
  string consumer_id = 1;

  /* Unique id for a savelist */
  string savelist_id = 2;

  /* Unique id for the link of the savelist and store */
  string savelist_store_link_id = 3;

  /* Unique id for a store entity */
  string store_id = 4;

  /* Direction 1 = save, 0 = unsave */
  int32 save_direction = 5;

  /* Experience id Doordash or Caviar */
  string experience_id = 6;

  /* Device platform */
  string platform = 7;

  /* Unique client session id */
  string dd_session_id = 8;

  /* Unique client device id */
  string dd_device_id = 9;

  /* UI component where the Cx executed the action (i.e. save_prompt_after_review) */
  string container = 10;
}

// Segment events
message ConvertGuestToAuthenticatedCxSegmentEvent {
  google.protobuf.StringValue service_source = 1;
}

// Segment Alias Event
message ConvertGuestToAuthenticatedCxSegmentAliasEvent {
  google.protobuf.StringValue service_source = 1;
  google.protobuf.StringValue previousId = 2;
}

// Segment event for when setConsumerDefaultAddress is called
message SetConsumerDefaultAddressEvent {
  // Primary key of the consumer address link the Cx has set default to
  google.protobuf.Int64Value new_address_link_id = 1;
  google.protobuf.StringValue consumer_id = 2;
  google.protobuf.StringValue address_id = 3;
  google.protobuf.StringValue source_place_id = 4;
}

// Event published via COPS when consumer signs up.
// it is same as event_trigger.proto in growth service proto. event trigger will be deprecated soon.
message ConsumerSignupEvent {
  // consumer id
  google.protobuf.Int64Value consumer_id = 1;
  // experience, i.e. doordash or caviar
  ConsumerExperience experience = 2;
  // country code
  google.protobuf.StringValue country_code = 3;
  // consumer creation timestamp
  google.protobuf.Timestamp created_at = 4;
  // consumer email
  google.protobuf.StringValue email = 5;
  // user id
  google.protobuf.Int64Value user_id = 6;
  // user preferred language (locale)
  google.protobuf.StringValue user_locale_preference = 7;
}

// ID-1817
message GuestConsumerReusedEvent {
  // consumer id
  string consumer_id = 1;
  // experience (e.g. doordash, storefront) of the Consumer which an obsolete Doordash Marketplace Consumer was recycled for
  ConsumerExperience experience = 2;
  // consumer sanitized email
  google.protobuf.StringValue email = 3;
  // user id
  string user_id = 4;
  // full guest consumer type e.g. drive, marketplace of the Consumer which an obsolete Doordash Marketplace Consumer was recycled for
  FullGuestConsumerType full_guest_consumer_type = 5;
}

// ID-2438
message CxSelfExclusionUpdatedEvent {
  // user id
  string user_id = 1;
  // item types that are blocked for the user_id
  repeated google.protobuf.StringValue item_types_blocked = 2;
  // User added the self exclusion for the given user_id
  string created_by = 3;
}
