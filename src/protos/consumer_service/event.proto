syntax = "proto3";

package doordash_consumer_service;

import "consumer_service/common.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

option go_package = "consumer_service";
option java_generic_services = true;
option java_multiple_files = true;
option java_package = "com.doordash.rpc.consumer_service";

// Events published to the `consumer_events` topic.
message ConsumerEvent {
  // A oneof is used so that there's a common type for the event publisher
  oneof event {
    // See documentation below.
    ConsumerCreatedEvent consumer_created = 1;
  }
}

/**
 * Publish when a (non-guest) Consumer gets created via COPS.
 *  This can happen on signup, or if a user has a DoorDash account
 *  and signs up for Caviar (and vice-versa).
 */
message ConsumerCreatedEvent {
  // Primary key (numeric)
  string id = 1;
  // Reference to Identity's User (numeric)
  string user_id = 2;
  // Typically DOORDASH or CAVIAR, should never be unspecified.
  ConsumerExperience experience = 3;
  // From database.
  google.protobuf.Timestamp created_at = 4;
}

/**
 * Type of change made to the consumer address link
 */
enum ConsumerAddressLinkEventType {
  // unknown
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_UNSPECIFIED = 0;
  // consumer address link created
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_CREATE = 1;
  // consumer address link patched
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_PATCH = 2;
  // consumer address link deleted
  CONSUMER_ADDRESS_LINK_EVENT_TYPE_DELETE = 3;
}

/**
 * Changes made to the consumer address link
 */
message ConsumerAddressLinkEvent {
  // primary key of the consumer address link
  string consumer_address_link_id = 1;
  // consumer ID
  string consumer_id = 2;
  // address ID generated by Geo
  string address_id = 3;
  // instructions to the dasher
  string dasher_instructions = 4;
  // subpremise (for example, apartment number)
  string subpremise = 5;
  // latitude of the manual point
  double manual_lat = 6;
  // longitude of the manual point
  double manual_lng = 7;

  // the JSON representation of the request proto coming into COPS
  string request_blob = 21;
  // type of change made to the consumer address link
  ConsumerAddressLinkEventType event_type = 22;
  // timestamp of the change
  google.protobuf.Timestamp sent_at = 23;

  // name of the personal address label associated with the consumer address link
  google.protobuf.StringValue label_name = 24;
  // icon of the personal address label associated with the consumer address link
  google.protobuf.StringValue label_icon = 25;
  // type of change made to the address label
  PersonalAddressLabelEventType label_event_type = 26;
  // platform that sent the request (e.g., web, ios, android)
  google.protobuf.StringValue platform = 27;
  // location_preference is a drop-off location preference that a Cx can specify - currently it is only being used for qualified hotels
  google.protobuf.StringValue location_preference = 28;
  // Parsed out id values from the dasher_instructions JSON blob
  google.protobuf.StringValue dropoff_preference = 29;
  // client version of the caller (e.g. web v1.729.1)
  google.protobuf.StringValue client_version = 30;
  // semver app version of the caller (e.g. 5.23.0)
  google.protobuf.StringValue app_version = 31;
}

// Type of change made to the associated personal address label
enum PersonalAddressLabelEventType {
  // unknown
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_UNSPECIFIED = 0;
  // personal address label was created
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_CREATE = 1;
  // personal address label was updated
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_UPDATE = 2;
  // personal address label was deleted
  PERSONAL_ADDRESS_LABEL_EVENT_TYPE_DELETE = 3;
}

/*
 * Savelist Event contains data regarding updates on store bookmarks and savelists
 * Tech design: https://drd.sh/0JP35zg8TsgBhebN/
 */
message SavelistUpdateEvent {
  /* Creator's consumer id */
  string consumer_id = 1;

  /* Unique id for a savelist */
  string savelist_id = 2;

  /* Unique id for the link of the savelist and store */
  string savelist_store_link_id = 3;

  /* Unique id for a store entity */
  string store_id = 4;

  /* Direction 1 = save, 0 = unsave */
  int32 save_direction = 5;

  /* Experience id Doordash or Caviar */
  string experience_id = 6;

  /* Device platform */
  string platform = 7;

  /* Unique client session id */
  string dd_session_id = 8;

  /* Unique client device id */
  string dd_device_id = 9;

  /* UI component where the Cx executed the action (i.e. save_prompt_after_review) */
  string container = 10;
}

// Segment events
message ConvertGuestToAuthenticatedCxSegmentEvent {
  google.protobuf.StringValue service_source = 1;
}

// Segment Alias Event
message ConvertGuestToAuthenticatedCxSegmentAliasEvent {
  google.protobuf.StringValue service_source = 1;
  google.protobuf.StringValue previousId = 2;
}
