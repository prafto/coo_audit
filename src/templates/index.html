<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COO Audit Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .sentiment-meter {
            height: 30px;
            background: linear-gradient(to right, #ff4d4d, #ffcc00, #4caf50);
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
        }
        .sentiment-indicator {
            width: 20px;
            height: 40px;
            background-color: #333;
            position: absolute;
            top: -5px;
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }
        .coo-timeline {
            margin: 20px 0;
            padding: 10px;
            border-left: 3px solid #0d6efd;
        }
        .coo-event {
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .coo-event-time {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">COO Audit Tool</h1>
        
        <div class="card">
            <div class="card-header">
                Case Analysis
            </div>
            <div class="card-body">
                <form id="analysisForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="caseNumber" class="form-label">Case Number</label>
                            <input type="text" class="form-control" id="caseNumber" name="case_number" required>
                        </div>
                        <div class="col-md-6">
                            <label for="storeId" class="form-label">Store ID (Optional)</label>
                            <input type="text" class="form-control" id="storeId" name="store_id">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Analyze Case</button>
                </form>
                
                <div class="loading mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Analyzing case data...</p>
                </div>
            </div>
        </div>
        
        <!-- COO Information Section -->
        <div id="cooSection" class="card" style="display: none;">
            <div class="card-header">
                Change of Ownership Information
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Store Information</h5>
                        <p><strong>Store ID:</strong> <span id="cooStoreId">N/A</span></p>
                        <p><strong>Store Name:</strong> <span id="cooStoreName">N/A</span></p>
                        <p><strong>Business ID:</strong> <span id="cooBusinessId">N/A</span></p>
                        <p><strong>Legal Business Name:</strong> <span id="cooLegalBusinessName">N/A</span></p>
                    </div>
                    <div class="col-md-6">
                        <h5>New Owner Information</h5>
                        <p><strong>Name:</strong> <span id="cooNewOwnerName">N/A</span></p>
                        <p><strong>Email:</strong> <span id="cooNewOwnerEmail">N/A</span></p>
                        <p><strong>Phone:</strong> <span id="cooNewOwnerPhone">N/A</span></p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>COO Process Timeline</h5>
                        <p><strong>Process Started:</strong> <span id="cooProcessStarted">N/A</span></p>
                        <p><strong>Process Ended:</strong> <span id="cooProcessEnded">N/A</span></p>
                        <p><strong>Total Duration:</strong> <span id="cooDuration">N/A</span></p>
                        <p><strong>Scheduled Cutoff Time:</strong> <span id="cooScheduledCutoffTime">N/A</span></p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>Status Information</h5>
                        <p><strong>Approval Status:</strong> <span id="cooApprovalStatus">N/A</span></p>
                        <p><strong>Onboarding Status:</strong> <span id="cooOnboardingStatus">N/A</span></p>
                        <p><strong>Approved At:</strong> <span id="cooApprovedAt">N/A</span></p>
                        <p><strong>Cancelled At:</strong> <span id="cooCancelledAt">N/A</span></p>
                    </div>
                    <div class="col-md-6">
                        <h5>Additional Information</h5>
                        <p><strong>Revoke Access:</strong> <span id="cooRevokeAccess">N/A</span></p>
                        <p><strong>Create New Business:</strong> <span id="cooCreateNewBusiness">N/A</span></p>
                        <p><strong>Payment Account ID:</strong> <span id="cooPaymentAccountId">N/A</span></p>
                        <p><strong>Pactsafe Activity ID:</strong> <span id="cooPactsafeActivityId">N/A</span></p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>COO Events</h5>
                        <div id="cooEvents" class="coo-timeline">
                            <p>No events found.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sentiment Analysis Section -->
        <div id="sentimentSection" class="card" style="display: none;">
            <div class="card-header">
                Sentiment Analysis
            </div>
            <div class="card-body">
                <h5>Sentiment-O-Meter</h5>
                <div class="sentiment-meter">
                    <div id="sentimentIndicator" class="sentiment-indicator" style="left: 50%;"></div>
                </div>
                <div class="row">
                    <div class="col-md-4 text-center">
                        <p>Negative</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <p>Neutral</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <p>Positive</p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>Email Statistics</h5>
                        <p><strong>Total Emails:</strong> <span id="totalEmails">0</span></p>
                        <p><strong>Support Emails:</strong> <span id="supportEmails">0</span></p>
                        <p><strong>Merchant Emails:</strong> <span id="merchantEmails">0</span></p>
                    </div>
                    <div class="col-md-6">
                        <h5>Sentiment Summary</h5>
                        <p><strong>Average Sentiment:</strong> <span id="averageSentiment">N/A</span></p>
                        <div id="sentimentDistribution"></div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>Email Timeline</h5>
                        <div id="emailTimeline"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Case Details Section -->
        <div id="caseSection" class="card" style="display: none;">
            <div class="card-header">
                Case Details
            </div>
            <div class="card-body">
                <div id="caseDetails"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const caseNumber = document.getElementById('caseNumber').value;
            const storeId = document.getElementById('storeId').value;
            
            if (!caseNumber) {
                alert('Please enter a case number');
                return;
            }
            
            // Show loading indicator
            document.querySelector('.loading').style.display = 'block';
            
            // Hide results sections
            document.getElementById('cooSection').style.display = 'none';
            document.getElementById('sentimentSection').style.display = 'none';
            document.getElementById('caseSection').style.display = 'none';
            
            // Make API request
            fetch('/analyze_case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `case_number=${encodeURIComponent(caseNumber)}&store_id=${encodeURIComponent(storeId)}`
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.querySelector('.loading').style.display = 'none';
                
                // Display COO information if available
                if (data.coo_data && Object.keys(data.coo_data).length > 0) {
                    document.getElementById('cooSection').style.display = 'block';
                    
                    // Update COO information
                    document.getElementById('cooStoreId').textContent = data.coo_data.store_id || 'N/A';
                    document.getElementById('cooStoreName').textContent = data.coo_data.store_name || 'N/A';
                    document.getElementById('cooBusinessId').textContent = data.coo_data.business_id || 'N/A';
                    document.getElementById('cooLegalBusinessName').textContent = data.coo_data.legal_business_name || 'N/A';
                    
                    document.getElementById('cooNewOwnerName').textContent = data.coo_data.new_owner_name || 'N/A';
                    document.getElementById('cooNewOwnerEmail').textContent = data.coo_data.new_owner_email || 'N/A';
                    document.getElementById('cooNewOwnerPhone').textContent = data.coo_data.new_owner_phone || 'N/A';
                    
                    document.getElementById('cooProcessStarted').textContent = data.coo_data.process_started || 'N/A';
                    document.getElementById('cooProcessEnded').textContent = data.coo_data.process_ended || 'N/A';
                    document.getElementById('cooDuration').textContent = data.coo_data.duration || 'N/A';
                    document.getElementById('cooScheduledCutoffTime').textContent = data.coo_data.scheduled_cutoff_time || 'N/A';
                    
                    document.getElementById('cooApprovalStatus').textContent = data.coo_data.approval_status || 'N/A';
                    document.getElementById('cooOnboardingStatus').textContent = data.coo_data.onboarding_status || 'N/A';
                    document.getElementById('cooApprovedAt').textContent = data.coo_data.approved_at || 'N/A';
                    document.getElementById('cooCancelledAt').textContent = data.coo_data.cancelled_at || 'N/A';
                    
                    document.getElementById('cooRevokeAccess').textContent = data.coo_data.revoke_access || 'N/A';
                    document.getElementById('cooCreateNewBusiness').textContent = data.coo_data.create_new_business || 'N/A';
                    document.getElementById('cooPaymentAccountId').textContent = data.coo_data.payment_account_id || 'N/A';
                    document.getElementById('cooPactsafeActivityId').textContent = data.coo_data.pactsafe_activity_id || 'N/A';
                    
                    // Update COO events
                    const cooEventsContainer = document.getElementById('cooEvents');
                    cooEventsContainer.innerHTML = '';
                    
                    if (data.coo_data.events && data.coo_data.events.length > 0) {
                        data.coo_data.events.forEach(event => {
                            const eventElement = document.createElement('div');
                            eventElement.className = 'coo-event';
                            eventElement.innerHTML = `<span class="coo-event-time">${event.time}</span>: ${event.type}`;
                            cooEventsContainer.appendChild(eventElement);
                        });
                    } else {
                        cooEventsContainer.innerHTML = '<p>No events found.</p>';
                    }
                }
                
                // Display sentiment analysis if available
                if (data.emails_data && Object.keys(data.emails_data).length > 0) {
                    document.getElementById('sentimentSection').style.display = 'block';
                    
                    // Update email statistics
                    document.getElementById('totalEmails').textContent = data.emails_data.emails ? data.emails_data.emails.length : 0;
                    document.getElementById('supportEmails').textContent = data.emails_data.support_emails || 0;
                    document.getElementById('merchantEmails').textContent = data.emails_data.merchant_emails || 0;
                    
                    // Update sentiment summary
                    if (data.emails_data.sentiment_timeline && data.emails_data.sentiment_timeline.length > 0) {
                        // Calculate average sentiment
                        const sentimentScores = data.emails_data.sentiment_timeline.map(entry => entry.score);
                        const avgSentiment = sentimentScores.reduce((sum, score) => sum + score, 0) / sentimentScores.length;
                        
                        document.getElementById('averageSentiment').textContent = avgSentiment.toFixed(2);
                        
                        // Update sentiment indicator position (0-100%)
                        const indicatorPosition = ((avgSentiment + 1) / 2) * 100; // Convert from -1 to 1 range to 0 to 100%
                        document.getElementById('sentimentIndicator').style.left = `${indicatorPosition}%`;
                        
                        // Update sentiment distribution
                        const sentimentDistribution = document.getElementById('sentimentDistribution');
                        sentimentDistribution.innerHTML = '';
                        
                        const categories = {};
                        data.emails_data.sentiment_timeline.forEach(entry => {
                            const category = entry.category;
                            categories[category] = (categories[category] || 0) + 1;
                        });
                        
                        for (const category in categories) {
                            const count = categories[category];
                            const percentage = (count / sentimentScores.length) * 100;
                            const categoryElement = document.createElement('p');
                            categoryElement.innerHTML = `<strong>${category}:</strong> ${count} emails (${percentage.toFixed(1)}%)`;
                            sentimentDistribution.appendChild(categoryElement);
                        }
                        
                        // Update email timeline
                        const emailTimeline = document.getElementById('emailTimeline');
                        emailTimeline.innerHTML = '';
                        
                        data.emails_data.sentiment_timeline.forEach(entry => {
                            const timelineEntry = document.createElement('div');
                            timelineEntry.className = 'coo-event';
                            timelineEntry.innerHTML = `<span class="coo-event-time">${entry.date}</span>: ${entry.category} (score: ${entry.score.toFixed(2)})`;
                            emailTimeline.appendChild(timelineEntry);
                        });
                    }
                }
                
                // Display case details if available
                if (data.case_details && Object.keys(data.case_details).length > 0) {
                    document.getElementById('caseSection').style.display = 'block';
                    
                    const caseDetailsContainer = document.getElementById('caseDetails');
                    caseDetailsContainer.innerHTML = '';
                    
                    for (const key in data.case_details) {
                        if (key !== 'error') {
                            const detailElement = document.createElement('p');
                            detailElement.innerHTML = `<strong>${key}:</strong> ${data.case_details[key]}`;
                            caseDetailsContainer.appendChild(detailElement);
                        }
                    }
                    
                    if (data.case_details.error) {
                        const errorElement = document.createElement('div');
                        errorElement.className = 'alert alert-danger';
                        errorElement.textContent = `Error: ${data.case_details.error}`;
                        caseDetailsContainer.appendChild(errorElement);
                    }
                }
            })
            .catch(error => {
                // Hide loading indicator
                document.querySelector('.loading').style.display = 'none';
                
                // Show error message
                alert(`Error: ${error.message}`);
            });
        });
    </script>
</body>
</html> 